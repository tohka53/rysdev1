import{Pa as p,Ta as v,Ua as u,d as f,f as c,h as a}from"./chunk-RRQC6EZP.js";import{g as o}from"./chunk-6AOLKZEJ.js";var l=class n{constructor(e,r){this.supabaseService=e;this.authService=r}userMenuSubject=new f([]);userMenu$=this.userMenuSubject.asObservable();userPermissionsSubject=new f([]);userPermissions$=this.userPermissionsSubject.asObservable();canAccessRoute(e){return o(this,null,function*(){let r=this.authService.getCurrentUser();return r?.id?(console.log("\u{1F50D} Verificando acceso a:",e,"Usuario ID:",r.id,"Perfil:",r.id_perfil),["/dashboard","/login","/register"].includes(e)?(console.log("\u2705 Ruta p\xFAblica, acceso permitido"),!0):e.includes("/paquetes")?yield this.checkPaquetesPermission(e,r.id):yield this.hasPermission(e,"view")):(console.log("\u274C Usuario no autenticado"),!1)})}checkPaquetesPermission(e,r){return o(this,null,function*(){try{console.log("\u{1F50D} Verificando permisos de paquetes para ruta:",e);let{data:i,error:s}=yield this.supabaseService.client.rpc("check_paquetes_permission",{p_user_id:r,p_route:e,p_permission_code:"view"});if(s)return console.error("\u274C Error llamando check_paquetes_permission:",s),this.checkPaquetesPermissionByProfile(e);let t=i===!0;return console.log(`${t?"\u2705":"\u274C"} Acceso a paquetes:`,t),t}catch(i){return console.error("\u274C Error en checkPaquetesPermission:",i),this.checkPaquetesPermissionByProfile(e)}})}checkPaquetesPermissionByProfile(e){let r=this.authService.getCurrentUser();if(!r||!r.id_perfil)return console.log("\u274C Usuario sin perfil v\xE1lido"),!1;let i=r.id_perfil;if(console.log("\u{1F527} Fallback: verificando por perfil",i,"para ruta:",e),i===1)return console.log("\u2705 Admin: acceso completo"),!0;if(i===3)return e.includes("/eliminar")||e.includes("/delete")?(console.log("\u274C Supervisor: no puede eliminar"),!1):(console.log("\u2705 Supervisor: acceso permitido"),!0);if(i===2){let t=["/paquetes","/paquetes/detalle","/paquetes/calendario"].some(d=>e===d||e.startsWith(d+"/")),S=["/crear","/editar","/asignar","/asignaciones"].some(d=>e.includes(d)),h=t&&!S;return console.log(`${h?"\u2705":"\u274C"} Usuario: ${h?"puede acceder":"acceso denegado"} a ${e}`),h}return console.log("\u274C Perfil no reconocido:",i),!1}hasPermission(e,r){return o(this,null,function*(){let i=this.authService.getCurrentUser();if(!i?.id)return!1;if(e.includes("/paquetes"))return yield this.checkPaquetesPermission(e,i.id);try{let{data:s,error:t}=yield this.supabaseService.client.rpc("user_has_permission",{p_user_id:i.id,p_route:e,p_permission_code:r});return t?(console.error("Error verificando permiso (funci\xF3n no existe):",t),!0):s===!0}catch(s){return console.error("Error en hasPermission:",s),!0}})}canViewPaquete(e){return o(this,null,function*(){let r=this.authService.getCurrentUser();if(!r?.id)return!1;try{let{data:i,error:s}=yield this.supabaseService.client.rpc("user_can_view_paquete",{p_user_id:r.id,p_paquete_id:e});return s?(console.error("Error verificando acceso a paquete:",s),!1):i===!0}catch(i){return console.error("Error en canViewPaquete:",i),!1}})}canAccessAsignaciones(){return o(this,null,function*(){let e=this.authService.getCurrentUser();if(!e?.id)return!1;try{let{data:r,error:i}=yield this.supabaseService.client.rpc("user_can_access_asignaciones",{p_user_id:e.id});return i?(console.error("Error verificando acceso a asignaciones:",i),!1):r===!0}catch(r){return console.error("Error en canAccessAsignaciones:",r),!1}})}loadUserMenu(){return o(this,null,function*(){let e=this.authService.getCurrentUser();if(!e?.id)return this.userMenuSubject.next([]),[];try{let{data:r,error:i}=yield this.supabaseService.client.rpc("get_user_menu",{p_user_id:e.id});if(i)return console.error("Error obteniendo men\xFA del usuario:",i),this.userMenuSubject.next([]),[];let s=this.buildMenuTree(r||[]);return this.userMenuSubject.next(s),s}catch(r){return console.error("Error en loadUserMenu:",r),this.userMenuSubject.next([]),[]}})}loadUserPermissions(){return o(this,null,function*(){let e=this.authService.getCurrentUser();if(!e?.id)return this.userPermissionsSubject.next([]),[];try{let{data:r,error:i}=yield this.supabaseService.client.from("v_permisos_usuario").select("*").eq("user_id",e.id).eq("granted",!0);if(i)return console.error("Error obteniendo permisos del usuario:",i),this.userPermissionsSubject.next([]),[];let s=r||[];return this.userPermissionsSubject.next(s),s}catch(r){return console.error("Error en loadUserPermissions:",r),this.userPermissionsSubject.next([]),[]}})}getCurrentUserMenu(){return o(this,null,function*(){return yield this.loadUserMenu()})}hasAnyPermission(e,r){return o(this,null,function*(){for(let i of r)if(yield this.hasPermission(e,i))return!0;return!1})}getUserPermissions(){return o(this,null,function*(){return yield this.loadUserPermissions()})}buildMenuTree(e){let r=new Map,i=[];return e.forEach(s=>{let t={id_modulo:s.modulo_id||s.id_modulo,nombre:s.nombre,descripcion:s.descripcion,icono:s.icono,ruta:s.ruta,orden:s.orden,es_padre:s.es_padre,modulo_padre_id:s.modulo_padre_id,permisos:s.permisos||[],children:[],expanded:!1};r.set(t.id_modulo,t)}),r.forEach(s=>{if(s.modulo_padre_id===null)i.push(s);else{let t=r.get(s.modulo_padre_id);t&&(t.children||(t.children=[]),t.children.push(s))}}),this.sortMenuItems(i),i}sortMenuItems(e){e.sort((r,i)=>r.orden-i.orden),e.forEach(r=>{r.children&&r.children.length>0&&this.sortMenuItems(r.children)})}canView(e){return o(this,null,function*(){return yield this.canAccessRoute(e)})}canCreate(e){return o(this,null,function*(){if(e.includes("/paquetes")){let r=this.authService.getCurrentUser();return r&&r.id_perfil?[1,3].includes(r.id_perfil):!1}return yield this.hasPermission(e,"create")})}canEdit(e){return o(this,null,function*(){if(e.includes("/paquetes")){let r=this.authService.getCurrentUser();return r&&r.id_perfil?[1,3].includes(r.id_perfil):!1}return yield this.hasPermission(e,"edit")})}canDelete(e){return o(this,null,function*(){if(e.includes("/paquetes")){let r=this.authService.getCurrentUser();return r&&r.id_perfil?r.id_perfil===1:!1}return yield this.hasPermission(e,"delete")})}canExport(e){return o(this,null,function*(){return yield this.hasPermission(e,"export")})}canAdmin(e){return o(this,null,function*(){return yield this.hasPermission(e,"admin")})}clearUserData(){this.userMenuSubject.next([]),this.userPermissionsSubject.next([])}refreshUserData(){return o(this,null,function*(){yield Promise.all([this.loadUserMenu(),this.loadUserPermissions()])})}getUserMenu(){return this.userMenu$}getUserPermissionsObservable(){return this.userPermissions$}createDefaultMenu(){let e=[{id_modulo:1,nombre:"Dashboard",descripcion:"Panel principal",icono:"fas fa-tachometer-alt",ruta:"/dashboard",orden:1,es_padre:!1,modulo_padre_id:null,permisos:["view"],expanded:!1}];return this.userMenuSubject.next(e),e}static \u0275fac=function(r){return new(r||n)(a(v),a(u))};static \u0275prov=c({token:n,factory:n.\u0275fac,providedIn:"root"})};var b=class n{constructor(e,r,i){this.authService=e;this.permissionsService=r;this.router=i}canActivate(e,r){return o(this,null,function*(){if(!this.authService.isAuthenticated())return console.log("Usuario no autenticado, redirigiendo a login"),this.router.navigate(["/login"]),!1;if(!this.authService.getCurrentUser())return console.log("No se pudo obtener el usuario actual"),this.router.navigate(["/login"]),!1;let s=r.url;if(console.log("Verificando acceso a ruta:",s),["/dashboard","/login","/register"].includes(s))return console.log("Ruta p\xFAblica, acceso permitido"),!0;try{return(yield this.permissionsService.canAccessRoute(s))?(console.log("Acceso autorizado a:",s),!0):(console.log("Usuario sin permisos para acceder a:",s),this.router.navigate(["/dashboard"],{queryParams:{error:"no_permissions",attempted_route:s}}),!1)}catch(m){return console.error("Error verificando permisos:",m),!0}})}static \u0275fac=function(r){return new(r||n)(a(u),a(l),a(p))};static \u0275prov=c({token:n,factory:n.\u0275fac,providedIn:"root"})},g=class n{constructor(e,r,i){this.authService=e;this.permissionsService=r;this.router=i}canActivate(e,r){return o(this,null,function*(){if(!this.authService.isAuthenticated())return this.router.navigate(["/login"]),!1;let i=e.data.permissions,s=r.url;if(!i||i.length===0)return yield this.permissionsService.canAccessRoute(s);try{return(yield this.permissionsService.hasAnyPermission(s,i))?!0:(console.log("Permisos insuficientes para:",s,"Requeridos:",i),this.router.navigate(["/dashboard"],{queryParams:{error:"insufficient_permissions",required:i.join(","),attempted_route:s}}),!1)}catch(t){return console.error("Error en PermissionGuard:",t),!1}})}static \u0275fac=function(r){return new(r||n)(a(u),a(l),a(p))};static \u0275prov=c({token:n,factory:n.\u0275fac,providedIn:"root"})},P=class n{constructor(e,r){this.authService=e;this.router=r}canActivate(e,r){if(!this.authService.isAuthenticated())return this.router.navigate(["/login"]),!1;let i=this.authService.getCurrentUser(),s=e.data.profiles;if(!s||s.length===0)return!0;let t=i?.id_perfil;return t?s.includes(t)?!0:(console.log("Perfil insuficiente:",t,"Requeridos:",s),this.router.navigate(["/dashboard"],{queryParams:{error:"insufficient_role",required:s.join(",")}}),!1):(console.log("Usuario sin perfil asignado"),this.router.navigate(["/dashboard"],{queryParams:{error:"no_profile"}}),!1)}static \u0275fac=function(r){return new(r||n)(a(u),a(p))};static \u0275prov=c({token:n,factory:n.\u0275fac,providedIn:"root"})};export{l as a,b,g as c,P as d};
